metadata:
  name: generate-router-rules
  description: Generate router rules by introspecting installed agents and skills
  version: 1.0.0
  lastUpdated: "2025-12-28"
  category: infrastructure
  output_path: router-rules.json
  source: ensemble-router
  allowed_tools:
    - Read
    - Write
    - Grep
    - Glob

mission:
  summary: |
    Introspect the current Claude Code session to discover all available agents
    and skills, then generate a router-rules.json with categorized keyword
    mappings for the UserPromptSubmit routing hook.

workflow:
  phases:
    - name: Agent Discovery
      order: 1
      steps:
        - order: 1
          title: Extract Available Agents
          description: |
            Examine your own Task tool documentation to extract all available
            subagent_type values. The Task tool description contains a list of
            all agent types with their descriptions.
          actions:
            - "Parse the subagent_type enum from Task tool documentation"
            - "Extract agent name and description for each agent type"
            - "Note the tools each agent has access to"

        - order: 2
          title: Categorize Agents by Domain
          description: |
            Group discovered agents into functional domains based on their
            descriptions and capabilities.
          actions:
            - "product_documentation: PRD, TRD, docs, requirements agents"
            - "orchestration: ensemble, tech-lead, product-management orchestrators"
            - "development: frontend, backend, mobile, infrastructure developers"
            - "quality_testing: code-reviewer, test-runner, debugger, playwright agents"
            - "infrastructure_build: deployment, build, release, infrastructure agents"
            - "utility: general-purpose, file-creator, context-fetcher, git agents"
            - "database: postgresql-specialist and database-related agents"

    - name: Skill Discovery
      order: 2
      steps:
        - order: 1
          title: Extract Available Skills
          description: |
            Examine the Skill tool documentation to extract all available skills
            from the <available_skills> section.
          actions:
            - "Parse skill names from the Skill tool's available_skills list"
            - "Extract description and location for each skill"
            - "Note any argument hints or usage patterns"

        - order: 2
          title: Generate Skill Keywords
          description: |
            Create keyword mappings for each skill based on its name,
            description, and common usage patterns. Include diagnostic patterns.
          actions:
            - "Primary keywords: skill name and variations"
            - "Technology keywords: related technologies and frameworks"
            - "Action keywords: verbs that suggest skill usage"
            - "Diagnostic keywords: issue, problem, not working patterns"
            - "Pattern keywords: regex patterns for complex matching"

    - name: Keyword Generation
      order: 3
      steps:
        - order: 1
          title: Generate Agent Keywords
          description: |
            For each agent category, generate trigger keywords that would
            indicate a prompt should be routed to agents in that category.
          actions:
            - "Extract action verbs from agent descriptions"
            - "Identify technology/domain terms"
            - "Add common synonyms and variations"
            - "Include command-style prefixes (create, build, deploy, etc.)"
            - "Add infrastructure terms (environment, services, hosting, healthy)"

        - order: 2
          title: Ensure Comprehensive Coverage
          description: |
            Make sure triggers cover common terminology that users might use.
          actions:
            - "Infrastructure: environment, services, hosting, healthy, CI/CD"
            - "Development: BFF, microservice, API, endpoint, implement"
            - "Diagnostic: issue, problem, error, not working, debug"

    - name: Rules Generation
      order: 4
      steps:
        - order: 1
          title: Assemble Rules Structure
          description: |
            Combine all discovered agents, skills, and keywords into the
            router-rules.json structure.
          actions:
            - "Create version and metadata section"
            - "Add agent_categories with triggers and agent lists"
            - "Add skills with keywords and patterns"
            - "Add injection_templates for all 8 scenarios"
            - "Add routing_rules configuration"

        - order: 2
          title: Write Rules File
          description: |
            Write the complete rules to router-rules.json
          actions:
            - "Use Write tool to create router-rules.json"
            - "Validate JSON structure before writing"
            - "Report summary of discovered agents and skills"

expectedOutput:
  format: JSON rules file at router-rules.json
  structure:
    - name: metadata
      description: Version, generated date, source information
    - name: agent_categories
      description: Agents grouped by domain with trigger keywords
    - name: skills
      description: Skills with keyword mappings, patterns, and diagnostic triggers
    - name: injection_templates
      description: 8 templates for different scenarios including project-specific
    - name: routing_rules
      description: Configuration settings like short_threshold_words
