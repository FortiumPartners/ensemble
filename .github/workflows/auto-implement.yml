name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Rate limit check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check how many auto-implement runs are in progress
          RUNNING=$(gh run list --workflow auto-implement.yml --status in_progress --json databaseId --jq 'length')
          if [ "$RUNNING" -gt 2 ]; then
            echo "::error::Rate limit exceeded â€” $RUNNING auto-implement runs already in progress (max 2)"
            exit 1
          fi

          # Check runs in the last hour
          RECENT=$(gh run list --workflow auto-implement.yml --created ">$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%SZ)" --json databaseId --jq 'length' 2>/dev/null || echo "0")
          if [ "$RECENT" -gt 5 ]; then
            echo "::error::Rate limit exceeded â€” $RECENT runs in the last hour (max 5)"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          npm ci

      - name: Configure git
        run: |
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH="feat/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Write issue body to file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body || 'No description provided.';
            fs.writeFileSync('/tmp/issue-body.txt', body);

      - name: Configure Claude Code restrictions
        run: |
          mkdir -p .claude
          cat > .claude/settings.json <<'SETTINGS'
          {
            "permissions": {
              "allow": [
                "Edit",
                "Write",
                "Read",
                "Bash(cat:*)",
                "Bash(ls:*)",
                "Bash(find:*)",
                "Bash(grep:*)",
                "Bash(head:*)",
                "Bash(tail:*)",
                "Bash(wc:*)",
                "Bash(mkdir:*)",
                "Bash(cp:*)",
                "Bash(mv:*)",
                "Bash(node:*)",
                "Bash(npm:*)",
                "Bash(npx:*)",
                "Bash(git diff:*)",
                "Bash(git log:*)",
                "Bash(git status:*)"
              ],
              "deny": [
                "Bash(curl:*)",
                "Bash(wget:*)",
                "Bash(git push:*)",
                "Bash(git commit:*)",
                "Bash(rm -rf:*)",
                "WebFetch",
                "WebSearch"
              ]
            }
          }
          SETTINGS

      - name: "Phase 1: Create PRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_BODY=$(cat /tmp/issue-body.txt)
          timeout 600 claude -p "Read CLAUDE.md for project context.

          Run /ensemble:create-prd with the following product description:

          ## Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Save the PRD to docs/PRD/issue-${ISSUE_NUMBER}.md

          Do NOT implement anything. Only create the PRD document."

      - name: "Verify Phase 1 output"
        run: |
          FILE="docs/PRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 1 failed â€” PRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 1 failed â€” PRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          echo "âœ… PRD created successfully (${SIZE} bytes)"

      - name: "Phase 2: Create TRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          timeout 600 claude -p "Read CLAUDE.md for project context.

          Run /ensemble:create-trd using the PRD at docs/PRD/issue-${ISSUE_NUMBER}.md

          Save the TRD to docs/TRD/issue-${ISSUE_NUMBER}.md

          Do NOT implement anything. Only create the TRD document."

      - name: "Verify Phase 2 output"
        run: |
          FILE="docs/TRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 2 failed â€” TRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 2 failed â€” TRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          echo "âœ… TRD created successfully (${SIZE} bytes)"

      - name: "Phase 3: Implement TRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          timeout 600 claude -p "Read CLAUDE.md for project context.

          Run /ensemble:implement-trd using the TRD at docs/TRD/issue-${ISSUE_NUMBER}.md

          Follow the project's coding standards and conventions.
          Include tests if applicable.
          Do NOT commit â€” just make the file changes."

      - name: Upload pipeline artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ensemble-pipeline-artifacts
          path: |
            docs/PRD/issue-${{ github.event.issue.number }}.md
            docs/TRD/issue-${{ github.event.issue.number }}.md
          if-no-files-found: ignore

      - name: Commit and push
        run: |
          # Remove the temporary settings file
          rm -f .claude/settings.json
          rmdir .claude 2>/dev/null || true

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes were made"
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            exit 0
          fi

          git add -A
          git commit -m "feat: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}

          Implemented via Ensemble pipeline:
          - PRD: docs/PRD/issue-${ISSUE_NUMBER}.md
          - TRD: docs/TRD/issue-${ISSUE_NUMBER}.md"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat <<EOF
          ## Auto-Implemented via Ensemble Pipeline

          This PR was automatically generated using the full Ensemble workflow from issue #${ISSUE_NUMBER}.

          ### Pipeline Phases
          1. **PRD** â€” \`/ensemble:create-prd\` â†’ \`docs/PRD/issue-${ISSUE_NUMBER}.md\`
          2. **TRD** â€” \`/ensemble:create-trd\` â†’ \`docs/TRD/issue-${ISSUE_NUMBER}.md\`
          3. **Implementation** â€” \`/ensemble:implement-trd\`

          ### Source Issue
          Closes #${ISSUE_NUMBER}

          ### âš ï¸ Review Required
          This is AI-generated code. Please review the PRD, TRD, and implementation carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*
          EOF
          )

          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "feat: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}" \
            --body "$PR_BODY")

          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Comment on issue (success)
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement complete!**

          The full Ensemble pipeline has been executed:
          1. âœ… PRD created
          2. âœ… TRD created
          3. âœ… Implementation complete

          PR: ${{ env.PR_URL }}

          Please review the changes and provide feedback."

      - name: Comment on issue (no changes)
        if: env.NO_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement pipeline completed but no file changes were produced.**

          The Ensemble pipeline ran but Claude Code did not generate implementation changes. This may need:
          - A more detailed issue description
          - Manual implementation
          - Review of the generated PRD/TRD for issues"

      - name: Comment on issue (failure)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement pipeline failed.**

          One of the Ensemble phases did not complete successfully. Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          Pipeline artifacts (if any) have been uploaded for debugging."
