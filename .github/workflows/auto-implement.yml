name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Verify authorized user
        run: |
          ALLOWED_USERS="ldangelo,bautrey,islayjames"
          if [[ ! ",$ALLOWED_USERS," == *",${{ github.actor }},"* ]]; then
            echo "::error::${{ github.actor }} is not authorized to trigger auto-implement"
            gh issue comment "${ISSUE_NUMBER}" \
              --body "⚠️ **Auto-implement not authorized.** Only designated users can trigger this workflow." \
              || true
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # TODO: Re-enable rate limiting after testing is complete
      # - name: Rate limit check
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     RUNNING=$(gh run list --workflow auto-implement.yml --status in_progress --json databaseId --jq 'length')
      #     if [ "$RUNNING" -gt 2 ]; then
      #       echo "::error::Rate limit exceeded — $RUNNING auto-implement runs already in progress (max 2)"
      #       exit 1
      #     fi
      #
      #     RECENT=$(gh run list --workflow auto-implement.yml --created ">$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%SZ)" --json databaseId --jq 'length' 2>/dev/null || echo "0")
      #     if [ "$RECENT" -gt 5 ]; then
      #       echo "::error::Rate limit exceeded — $RECENT runs in the last hour (max 5)"
      #       exit 1
      #     fi

      - name: Detect issue type
        run: |
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
          echo "Labels: $LABELS"

          if echo "$LABELS" | grep -qi '"bug"'; then
            echo "ISSUE_TYPE=fix" >> "$GITHUB_ENV"
            echo "BRANCH_PREFIX=fix" >> "$GITHUB_ENV"
            echo "COMMIT_PREFIX=fix" >> "$GITHUB_ENV"
            echo "Detected issue type: Bug → fix-issue workflow"
          elif echo "$LABELS" | grep -qi '"task"'; then
            echo "ISSUE_TYPE=fix" >> "$GITHUB_ENV"
            echo "BRANCH_PREFIX=fix" >> "$GITHUB_ENV"
            echo "COMMIT_PREFIX=fix" >> "$GITHUB_ENV"
            echo "Detected issue type: Task → fix-issue workflow"
          else
            echo "ISSUE_TYPE=feature" >> "$GITHUB_ENV"
            echo "BRANCH_PREFIX=feat" >> "$GITHUB_ENV"
            echo "COMMIT_PREFIX=feat" >> "$GITHUB_ENV"
            echo "Detected issue type: Feature → full PRD/TRD pipeline"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure git
        run: |
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

      - name: Create branch
        run: |
          BRANCH="${BRANCH_PREFIX}/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Write issue body to workspace file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body || 'No description provided.';
            fs.mkdirSync('.github/issue-context', { recursive: true });
            fs.writeFileSync('.github/issue-context/issue-body.md', body);

      # ============================================================
      # Fix-Issue path (Bug / Task labels)
      # ============================================================

      - name: "Fix Issue: Analyze and implement"
        if: env.ISSUE_TYPE == 'fix'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:fix-issue for the following issue:

            ## Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            The full issue body is in the file .github/issue-context/issue-body.md — read it for the complete description.

            IMPORTANT CI constraints:
            - Do NOT create a git branch (already created: ${{ env.BRANCH }})
            - Do NOT commit or push changes
            - Do NOT create a PR
            - Just analyze the issue, plan the fix, implement changes, and run tests
            - Make all file changes directly
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      # ============================================================
      # Feature path (Feature label or default)
      # ============================================================

      - name: "Phase 1: Create PRD"
        if: env.ISSUE_TYPE == 'feature'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:create-prd with the following product description:

            ## Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            The full issue body is in the file .github/issue-context/issue-body.md — read it for the complete description.

            Save the PRD to docs/PRD/issue-${{ github.event.issue.number }}.md

            Do NOT implement anything. Only create the PRD document.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      - name: "Verify Phase 1 output"
        if: env.ISSUE_TYPE == 'feature'
        run: |
          FILE="docs/PRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 1 failed — PRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 1 failed — PRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          # Verify it has meaningful content (not just whitespace/boilerplate)
          if ! grep -qi -E "(requirement|goal|feature|user|problem|solution)" "$FILE"; then
            echo "::warning::PRD may lack substantive content — review manually"
          fi
          echo "✅ PRD created successfully (${SIZE} bytes)"

      - name: "Phase 2: Create TRD"
        if: env.ISSUE_TYPE == 'feature'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:create-trd using the PRD at docs/PRD/issue-${{ github.event.issue.number }}.md

            Save the TRD to docs/TRD/issue-${{ github.event.issue.number }}.md

            Do NOT implement anything. Only create the TRD document.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      - name: "Verify Phase 2 output"
        if: env.ISSUE_TYPE == 'feature'
        run: |
          FILE="docs/TRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 2 failed — TRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 2 failed — TRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          if ! grep -qi -E "(architecture|implementation|component|endpoint|schema|interface)" "$FILE"; then
            echo "::warning::TRD may lack technical content — review manually"
          fi
          echo "✅ TRD created successfully (${SIZE} bytes)"

      - name: "Phase 3: Implement TRD"
        if: env.ISSUE_TYPE == 'feature'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:implement-trd using the TRD at docs/TRD/issue-${{ github.event.issue.number }}.md

            Follow the project's coding standards and conventions.
            Include tests if applicable.
            Do NOT commit — just make the file changes.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      # ============================================================
      # Shared: Commit, PR, and issue comments
      # ============================================================

      - name: Upload pipeline artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ensemble-pipeline-artifacts
          path: |
            docs/PRD/issue-${{ github.event.issue.number }}.md
            docs/TRD/issue-${{ github.event.issue.number }}.md
          if-no-files-found: ignore

      - name: Clean up temporary files
        run: rm -rf .github/issue-context

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Re-authenticate git after claude-code-action cleanup revokes its token
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes were made"
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ "$ISSUE_TYPE" = "fix" ]; then
            COMMIT_MSG="${COMMIT_PREFIX}: fix #${ISSUE_NUMBER} - ${ISSUE_TITLE}

          Implemented via Ensemble fix-issue workflow"
          else
            COMMIT_MSG="${COMMIT_PREFIX}: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}

          Implemented via Ensemble pipeline:
          - PRD: docs/PRD/issue-${ISSUE_NUMBER}.md
          - TRD: docs/TRD/issue-${ISSUE_NUMBER}.md"
          fi

          git add -A
          git commit -m "$COMMIT_MSG"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "$ISSUE_TYPE" = "fix" ]; then
            PR_TITLE="${COMMIT_PREFIX}: fix #${ISSUE_NUMBER} - ${ISSUE_TITLE}"
            PR_BODY=$(cat <<'EOF'
          ## Auto-Fixed via Ensemble Fix-Issue

          This PR was automatically generated using the lightweight fix-issue workflow from issue #$ISSUE_NUMBER_PLACEHOLDER.

          ### Workflow
          - **Type:** Bug/Task fix (lightweight path)
          - **Command:** `/ensemble:fix-issue --issue $ISSUE_NUMBER_PLACEHOLDER`

          ### Source Issue
          Closes #$ISSUE_NUMBER_PLACEHOLDER

          ### Review Required
          This is AI-generated code. Please review the implementation and tests carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*
          EOF
          )
            PR_BODY="${PR_BODY//\$ISSUE_NUMBER_PLACEHOLDER/$ISSUE_NUMBER}"
          else
            PR_TITLE="${COMMIT_PREFIX}: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}"
            PR_BODY=$(cat <<'EOF'
          ## Auto-Implemented via Ensemble Pipeline

          This PR was automatically generated using the full Ensemble workflow from issue #$ISSUE_NUMBER_PLACEHOLDER.

          ### Pipeline Phases
          1. **PRD** — `/ensemble:create-prd` → `docs/PRD/issue-$ISSUE_NUMBER_PLACEHOLDER.md`
          2. **TRD** — `/ensemble:create-trd` → `docs/TRD/issue-$ISSUE_NUMBER_PLACEHOLDER.md`
          3. **Implementation** — `/ensemble:implement-trd`

          ### Source Issue
          Closes #$ISSUE_NUMBER_PLACEHOLDER

          ### Review Required
          This is AI-generated code. Please review the PRD, TRD, and implementation carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*
          EOF
          )
            PR_BODY="${PR_BODY//\$ISSUE_NUMBER_PLACEHOLDER/$ISSUE_NUMBER}"
          fi

          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$PR_TITLE" \
            --body "$PR_BODY")

          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Comment on issue (success - fix)
        if: env.NO_CHANGES != 'true' && env.ISSUE_TYPE == 'fix'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "**Auto-fix complete!**

          The fix-issue workflow has been executed:
          1. Issue analyzed
          2. Fix implemented
          3. Tests validated

          PR: ${{ env.PR_URL }}

          Please review the changes and provide feedback."

      - name: Comment on issue (success - feature)
        if: env.NO_CHANGES != 'true' && env.ISSUE_TYPE == 'feature'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "**Auto-implement complete!**

          The full Ensemble pipeline has been executed:
          1. PRD created
          2. TRD created
          3. Implementation complete

          PR: ${{ env.PR_URL }}

          Please review the changes and provide feedback."

      - name: Comment on issue (no changes)
        if: env.NO_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "$ISSUE_TYPE" = "fix" ]; then
            PIPELINE="fix-issue"
          else
            PIPELINE="full PRD/TRD"
          fi

          gh issue comment "${ISSUE_NUMBER}" \
            --body "**Auto-implement pipeline completed but no file changes were produced.**

          The $PIPELINE pipeline ran but Claude Code did not generate implementation changes. This may need:
          - A more detailed issue description
          - Manual implementation
          - Review of the generated artifacts for issues"

      - name: Comment on issue (failure)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "**Auto-implement pipeline failed.**

          One of the Ensemble phases did not complete successfully. Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          Pipeline artifacts (if any) have been uploaded for debugging."
