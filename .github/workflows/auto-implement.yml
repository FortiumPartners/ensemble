name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Verify authorized user
        run: |
          ALLOWED_USERS="ldangelo,bautrey,islayjames"
          if [[ ! ",$ALLOWED_USERS," == *",${{ github.actor }},"* ]]; then
            echo "::error::${{ github.actor }} is not authorized to trigger auto-implement"
            gh issue comment "${ISSUE_NUMBER}" \
              --body "âš ï¸ **Auto-implement not authorized.** Only designated users can trigger this workflow." \
              || true
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # TODO: Re-enable rate limiting after testing is complete
      # - name: Rate limit check
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     RUNNING=$(gh run list --workflow auto-implement.yml --status in_progress --json databaseId --jq 'length')
      #     if [ "$RUNNING" -gt 2 ]; then
      #       echo "::error::Rate limit exceeded â€” $RUNNING auto-implement runs already in progress (max 2)"
      #       exit 1
      #     fi
      #
      #     RECENT=$(gh run list --workflow auto-implement.yml --created ">$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%SZ)" --json databaseId --jq 'length' 2>/dev/null || echo "0")
      #     if [ "$RECENT" -gt 5 ]; then
      #       echo "::error::Rate limit exceeded â€” $RECENT runs in the last hour (max 5)"
      #       exit 1
      #     fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Configure git
        run: |
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH="feat/issue-${ISSUE_NUMBER}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Write issue body to workspace file
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body || 'No description provided.';
            fs.mkdirSync('.github/issue-context', { recursive: true });
            fs.writeFileSync('.github/issue-context/issue-body.md', body);

      - name: "Phase 1: Create PRD"
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:create-prd with the following product description:

            ## Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            The full issue body is in the file .github/issue-context/issue-body.md â€” read it for the complete description.

            Save the PRD to docs/PRD/issue-${{ github.event.issue.number }}.md

            Do NOT implement anything. Only create the PRD document.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      - name: "Verify Phase 1 output"
        run: |
          FILE="docs/PRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 1 failed â€” PRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 1 failed â€” PRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          # Verify it has meaningful content (not just whitespace/boilerplate)
          if ! grep -qi -E "(requirement|goal|feature|user|problem|solution)" "$FILE"; then
            echo "::warning::PRD may lack substantive content â€” review manually"
          fi
          echo "âœ… PRD created successfully (${SIZE} bytes)"

      - name: "Phase 2: Create TRD"
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:create-trd using the PRD at docs/PRD/issue-${{ github.event.issue.number }}.md

            Save the TRD to docs/TRD/issue-${{ github.event.issue.number }}.md

            Do NOT implement anything. Only create the TRD document.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      - name: "Verify Phase 2 output"
        run: |
          FILE="docs/TRD/issue-${ISSUE_NUMBER}.md"
          if [ ! -f "$FILE" ]; then
            echo "::error::Phase 2 failed â€” TRD was not created"
            exit 1
          fi
          SIZE=$(wc -c < "$FILE")
          if [ "$SIZE" -lt 200 ]; then
            echo "::error::Phase 2 failed â€” TRD appears empty or too short (${SIZE} bytes)"
            exit 1
          fi
          if ! grep -qi -E "(architecture|implementation|component|endpoint|schema|interface)" "$FILE"; then
            echo "::warning::TRD may lack technical content â€” review manually"
          fi
          echo "âœ… TRD created successfully (${SIZE} bytes)"

      - name: "Phase 3: Implement TRD"
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Read CLAUDE.md for project context.

            Run /ensemble:implement-trd using the TRD at docs/TRD/issue-${{ github.event.issue.number }}.md

            Follow the project's coding standards and conventions.
            Include tests if applicable.
            Do NOT commit â€” just make the file changes.
          claude_args: '--allowed-tools "Edit,Write,Read,Bash(cat:*),Bash(ls:*),Bash(find:*),Bash(grep:*),Bash(head:*),Bash(tail:*),Bash(wc:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(node:*),Bash(npm:*),Bash(npx:*),Bash(git diff:*),Bash(git log:*),Bash(git status:*)"'

      - name: Upload pipeline artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ensemble-pipeline-artifacts
          path: |
            docs/PRD/issue-${{ github.event.issue.number }}.md
            docs/TRD/issue-${{ github.event.issue.number }}.md
          if-no-files-found: ignore

      - name: Clean up temporary files
        run: rm -rf .github/issue-context

      - name: Commit and push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Re-authenticate git after claude-code-action cleanup revokes its token
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes were made"
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            exit 0
          fi

          git add -A
          git commit -m "feat: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}

          Implemented via Ensemble pipeline:
          - PRD: docs/PRD/issue-${ISSUE_NUMBER}.md
          - TRD: docs/TRD/issue-${ISSUE_NUMBER}.md"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat <<EOF
          ## Auto-Implemented via Ensemble Pipeline

          This PR was automatically generated using the full Ensemble workflow from issue #${ISSUE_NUMBER}.

          ### Pipeline Phases
          1. **PRD** â€” \`/ensemble:create-prd\` â†’ \`docs/PRD/issue-${ISSUE_NUMBER}.md\`
          2. **TRD** â€” \`/ensemble:create-trd\` â†’ \`docs/TRD/issue-${ISSUE_NUMBER}.md\`
          3. **Implementation** â€” \`/ensemble:implement-trd\`

          ### Source Issue
          Closes #${ISSUE_NUMBER}

          ### âš ï¸ Review Required
          This is AI-generated code. Please review the PRD, TRD, and implementation carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*
          EOF
          )

          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "feat: implement #${ISSUE_NUMBER} - ${ISSUE_TITLE}" \
            --body "$PR_BODY")

          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Comment on issue (success)
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement complete!**

          The full Ensemble pipeline has been executed:
          1. âœ… PRD created
          2. âœ… TRD created
          3. âœ… Implementation complete

          PR: ${{ env.PR_URL }}

          Please review the changes and provide feedback."

      - name: Comment on issue (no changes)
        if: env.NO_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement pipeline completed but no file changes were produced.**

          The Ensemble pipeline ran but Claude Code did not generate implementation changes. This may need:
          - A more detailed issue description
          - Manual implementation
          - Review of the generated PRD/TRD for issues"

      - name: Comment on issue (failure)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "ðŸ¤– **Auto-implement pipeline failed.**

          One of the Ensemble phases did not complete successfully. Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          Pipeline artifacts (if any) have been uploaded for debugging."
