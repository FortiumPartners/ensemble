name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create feature branch
        run: |
          BRANCH="feat/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Run Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
          )

          PROMPT="You are working on the Ensemble framework. Read CLAUDE.md for project context and conventions.

          Implement the following GitHub issue:

          ## Issue #${{ github.event.issue.number }}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Instructions:
          - Follow the project's coding standards and conventions from CLAUDE.md
          - Write clean, well-documented code
          - Include tests if the project has a test framework set up
          - Do NOT commit â€” just make the file changes"

          claude -p "$PROMPT" --allowedTools "Edit,Write,Read,Bash(git diff:*),Bash(find:*),Bash(cat:*),Bash(ls:*),Bash(grep:*),Bash(node:*),Bash(npm:*)"

      - name: Commit and push
        run: |
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes were made by Claude Code"
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            exit 0
          fi
          
          git add -A
          git commit -m "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" \
            --body "## Auto-Implemented Issue

          This PR was automatically generated by Claude Code from issue #${{ github.event.issue.number }}.

          ### Source Issue
          Closes #${{ github.event.issue.number }}

          ### What was done
          Claude Code read the issue description and implemented the requested changes following the project's conventions in CLAUDE.md.

          ### âš ï¸ Review Required
          This is AI-generated code. Please review carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*")
          
          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Comment on issue
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– **Auto-implement complete!**
          
          A PR has been created with the implementation: ${{ env.PR_URL }}
          
          Please review the changes and provide feedback."

      - name: Comment on issue (no changes)
        if: env.NO_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– **Auto-implement attempted but no changes were made.**
          
          Claude Code was unable to produce file changes for this issue. This may need manual implementation or a more detailed issue description."
