name: Auto-Implement Issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-implement-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  implement:
    if: contains(github.event.issue.labels.*.name, 'auto-implement')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          npm install -g @anthropic-ai/claude-code
          npm ci

      - name: Create feature branch
        run: |
          BRANCH="feat/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: "Phase 1: Create PRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(cat <<'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
          )

          claude -p "Read CLAUDE.md for project context.

          Run /ensemble:create-prd with the following product description:

          ## Issue #${{ github.event.issue.number }}: ${ISSUE_TITLE}

          ${ISSUE_BODY}

          Save the PRD to docs/PRD/issue-${{ github.event.issue.number }}.md

          Do NOT implement anything. Only create the PRD document."

      - name: "Phase 2: Create TRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Read CLAUDE.md for project context.

          Run /ensemble:create-trd using the PRD at docs/PRD/issue-${{ github.event.issue.number }}.md

          Save the TRD to docs/TRD/issue-${{ github.event.issue.number }}.md

          Do NOT implement anything. Only create the TRD document."

      - name: "Phase 3: Implement TRD"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Read CLAUDE.md for project context.

          Run /ensemble:implement-trd using the TRD at docs/TRD/issue-${{ github.event.issue.number }}.md

          Follow the project's coding standards and conventions.
          Include tests if applicable.
          Do NOT commit â€” just make the file changes."

      - name: Commit and push
        run: |
          git config user.name "ensemble-bot"
          git config user.email "ensemble-bot@users.noreply.github.com"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes were made"
            echo "NO_CHANGES=true" >> "$GITHUB_ENV"
            exit 0
          fi

          git add -A
          git commit -m "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}

          Implemented via Ensemble pipeline:
          - PRD: docs/PRD/issue-${{ github.event.issue.number }}.md
          - TRD: docs/TRD/issue-${{ github.event.issue.number }}.md"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}" \
            --body "## Auto-Implemented via Ensemble Pipeline

          This PR was automatically generated using the full Ensemble workflow from issue #${{ github.event.issue.number }}.

          ### Pipeline Phases
          1. **PRD** â€” \`/ensemble:create-prd\` â†’ \`docs/PRD/issue-${{ github.event.issue.number }}.md\`
          2. **TRD** â€” \`/ensemble:create-trd\` â†’ \`docs/TRD/issue-${{ github.event.issue.number }}.md\`
          3. **Implementation** â€” \`/ensemble:implement-trd\`

          ### Source Issue
          Closes #${{ github.event.issue.number }}

          ### âš ï¸ Review Required
          This is AI-generated code. Please review the PRD, TRD, and implementation carefully before merging.

          ---
          *Generated by [auto-implement](../blob/main/docs/auto-implement.md) workflow*")

          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Comment on issue
        if: env.NO_CHANGES != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– **Auto-implement complete!**

          The full Ensemble pipeline has been executed:
          1. âœ… PRD created
          2. âœ… TRD created
          3. âœ… Implementation complete

          PR: ${{ env.PR_URL }}

          Please review the changes and provide feedback."

      - name: Comment on issue (no changes)
        if: env.NO_CHANGES == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ðŸ¤– **Auto-implement pipeline completed but no file changes were produced.**

          The Ensemble pipeline ran but Claude Code did not generate implementation changes. This may need:
          - A more detailed issue description
          - Manual implementation
          - Review of the generated PRD/TRD for issues"
